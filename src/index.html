<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Assinaturas - TOPGEO</title>
  <link rel="icon" type="image/png" href="https://topgeobr.com/img/logo.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1a5276;
      --secondary-color: #00bcd4;
      --accent-color: #154360;
      --light-bg: #f8fbfd;
      --card-bg: #ffffff;
      --text-dark: #333333;
      --text-medium: #555555;
      --text-light: #777777;
      --border-color: #e0e9f2;
      --success-color: #2ecc71;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--light-bg);
      margin: 0;
      padding: 0;
      color: var(--text-dark);
    }
    
    .dashboard {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 260px;
      background: var(--primary-color);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 0;
      min-height: 100vh;
      box-shadow: 2px 0 20px rgba(26, 82, 118, 0.15);
    }
    
    .sidebar .logo-panel {
      text-align: center;
      padding: 30px 20px;
      background: rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .sidebar .logo-panel img {
      height: 50px;
      margin-bottom: 12px;
    }
    
    .sidebar .logo-panel .empresa {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: white;
    }
    
    .sidebar nav {
      flex: 1;
      padding: 0 15px;
    }
    
    .sidebar nav a {
      display: flex;
      align-items: center;
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      padding: 14px 20px;
      font-size: 1rem;
      border-radius: 8px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }
    
    .sidebar nav a i {
      margin-right: 12px;
      font-size: 1.1rem;
      width: 24px;
      text-align: center;
    }
    
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .sidebar .footer {
      text-align: center;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .main-panel {
      flex: 1;
      padding: 30px 40px;
      background: var(--light-bg);
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .panel-header h1 {
      font-size: 1.8rem;
      color: var(--primary-color);
      font-weight: 700;
      margin: 0;
    }
    
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .kpi-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 22px;
      display: flex;
      flex-direction: column;
      border-left: 4px solid var(--primary-color);
    }
    
    .kpi-card .kpi-label {
      font-size: 1rem;
      color: var(--text-medium);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .kpi-card .kpi-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    
    .kpi-card .kpi-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.8rem;
      color: rgba(26, 82, 118, 0.1);
    }
    
    .painel-form {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      padding: 30px;
      margin-bottom: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid var(--border-color);
    }
    
    .painel-form h2 {
      font-size: 1.4rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 5px;
    }
    
    .form-group label {
      font-weight: 500;
      color: var(--primary-color);
      display: block;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--light-bg);
    }
    
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--light-bg);
      appearance: none;
      -moz-appearance: none;
      -webkit-appearance: none;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 24px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f4f8;
      color: var(--text-medium);
    }
    
    /* Estilo da Assinatura */
    .assinatura-container {
      background: transparent !important;
      padding: 20px 0 !important;
      max-width: 600px !important;
      margin: 0 auto 30px auto !important;
    }
    
    .assinatura {
      font-family: 'Poppins', sans-serif;
      color: #333;
      line-height: 1.5;
      background: transparent !important;
    }
    
    .assinatura-nome {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .assinatura-cargo {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .assinatura-contato {
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .assinatura-logo {
      margin-top: 20px;
    }
    
    .assinatura-logo img {
      height: 50px;
    }
    
    .assinatura-divider {
      border-top: 1px solid #ddd;
      margin: 15px 0;
    }
    
    /* Painel de Histórico */
    .painel-historico {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 30px;
      max-width: 900px;
      margin: 40px auto 0 auto;
      border: 1px solid var(--border-color);
    }
    
    .historico-card {
      display: flex;
      align-items: center;
      background: var(--light-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border-color);
      margin-bottom: 15px;
      padding: 15px 20px;
      gap: 20px;
    }
    
    .historico-info {
      flex: 1;
      min-width: 0;
    }
    
    .historico-nome {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary-color);
      margin-bottom: 2px;
    }
    
    .historico-cargo {
      color: var(--text-medium);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    .historico-contato {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .historico-data {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      margin-left: 15px;
    }
    
    .historico-acoes {
      display: flex;
      gap: 8px;
    }
    
    .btn-historico {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: white;
      border: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .assinatura {
        padding: 15px !important;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo-panel">
        <img src="https://topgeobr.com/img/logo.png" alt="Logo Topgeo">
        <div class="empresa">TOPGEO</div>
      </div>
      <nav>
        <a href="#" id="btn-painel" class="active"><i class="fas fa-plus-circle"></i> Criar Assinatura</a>
        <a href="#" id="btn-assinaturas"><i class="fas fa-history"></i> Histórico de Assinaturas</a>
        <a href="#" id="btn-templates"><i class="fas fa-palette"></i> Templates</a>
        <a href="#" id="btn-config"><i class="fas fa-cog"></i> Configurações</a>
      </nav>
      <div class="footer">© 2025 TOPGEO • v2.0</div>
    </aside>
    <main class="main-panel">
      <!-- Seção Principal -->
      <div id="sec-painel">
        <div class="panel-header">
          <h1><i class="fas fa-signature"></i> Criar Nova Assinatura</h1>
        </div>
        
        <div class="kpi-row">
          <div class="kpi-card kpi-shadow">
            <div class="kpi-label">
              <i class="fas fa-file-medical" style="color:#1a5276; margin-right:8px;"></i>
              Assinaturas Criadas
            </div>
            <div class="kpi-value" id="kpi-total">0</div>
          </div>
          <div class="kpi-card kpi-shadow">
            <div class="kpi-label">
              <i class="fas fa-check-circle" style="color:#2ecc71; margin-right:8px;"></i>
              Assinaturas Verificadas
            </div>
            <div class="kpi-value" id="kpi-verificadas">0</div>
          </div>
          <div class="kpi-card kpi-shadow">
            <div class="kpi-label">
              <i class="fas fa-calendar-alt" style="color:#00bcd4; margin-right:8px;"></i>
              Última Criação
            </div>
            <div class="kpi-value" id="kpi-ultima">-</div>
          </div>
        </div>
        
        <div class="painel-form">
          <h2><i class="fas fa-user-edit"></i> Informações Pessoais</h2>
          <form id="form-assinatura">
            <div class="form-grid">
              <div class="form-group">
                <label for="nome"><i class="fas fa-user"></i> Nome Completo:</label>
                <input id="nome" type="text" placeholder="Ex: Willian Melo" autocomplete="off" required>
              </div>
              <div class="form-group">
                <label for="cargo"><i class="fas fa-briefcase"></i> Cargo:</label>
                <input id="cargo" type="text" placeholder="Ex: Analista de Processos" autocomplete="off" required>
              </div>
              <div class="form-group">
                <label for="telefone1"><i class="fas fa-phone"></i> Telefone 1:</label>
                <input id="telefone1" type="tel" placeholder="(94) 98809-9845" autocomplete="off" required>
              </div>
              <div class="form-group">
                <label for="telefone2"><i class="fas fa-phone"></i> Telefone 2 (Opcional):</label>
                <input id="telefone2" type="tel" placeholder="(94) 98161-5473" autocomplete="off">
              </div>
              <div class="form-group">
                <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                <input id="email" type="email" placeholder="email@topgeo.com.br" autocomplete="off" required>
              </div>
              <div class="form-group">
                <label for="localidade"><i class="fas fa-map-marker-alt"></i> Localidade:</label>
                <select id="localidade" required>
                  <!-- Opções serão preenchidas via JS -->
                </select>
              </div>
              <div class="form-group">
                <label for="site"><i class="fas fa-globe"></i> Site:</label>
                <input id="site" type="url" placeholder="www.topgeoengenharia.com.br" value="https://www.topgeobr.com" autocomplete="off" required>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="reset" class="btn btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-magic"></i> Gerar Assinatura</button>
            </div>
          </form>
        </div>
        
        <div class="painel-form">
          <h2><i class="fas fa-eye"></i> Pré-visualização</h2>
          <div class="assinatura-container">
            <div class="assinatura" id="assinatura" style="background:#f8fbfd; border:none; padding:40px 0 20px 0; max-width:600px;">
  <table style="width:100%; border:none;">
    <tr>
      <td style="width:160px; text-align:center; vertical-align:middle; padding:0 18px 0 0;">
        <img src="logo.png" alt="TOPGEO" style="height:60px; margin-top:8px; margin-bottom:8px;"><br>
      </td>
      <td style="width:3px; background:#1a5276; opacity:1;"></td>
      <td style="padding-left:18px; vertical-align:middle;">
        <div style="font-weight:700; font-size:1.18em; color:#000; margin-bottom:2px; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-user" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-nome">Willian Melo</span>
          <i class="fas fa-circle-check" style="color:#3498db; font-size:1em; margin-left:8px; text-shadow: 0 0 1px #fff;"></i>
        </div>
        <div style="font-size:1em; color:#000; font-weight:400; margin-bottom:7px; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-briefcase" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-cargo">Analista de Processos</span>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-phone" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-telefones">94988099845</span>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-envelope" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <a id="sig-email-link" href="mailto:Willian.melo@topgeobr.com" style="color:#1a5276; text-decoration:underline;">
            <span id="sig-email">Willian.melo@topgeobr.com</span>
          </a>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-map-marker-alt" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-endereco">Escritorio Central</span>
        </div>
        <div style="font-size:0.98em;">
          <i class="fas fa-globe" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <a id="sig-site-link" href="#" onclick="abrirSiteNaMesmaJanela()" style="color:#1a5276; text-decoration:underline;">
            <span id="sig-site">www.topgeobr.com</span>
          </a>
        </div>
      </td>
    </tr>
  </table>
</div>
          </div>
          
          <div class="form-actions" style="justify-content: center;">
            <button class="btn btn-primary" onclick="exportarPNG()"><i class="fas fa-download"></i> Exportar PNG</button>
          </div>
        </div>
      </div>
      
      <!-- Seção de Histórico -->
      <div id="sec-assinaturas" style="display:none;">
        <div class="panel-header">
          <h1><i class="fas fa-history"></i> Histórico de Assinaturas</h1>
        </div>
        
        <div class="painel-historico">
          <div id="historico-lista">
  <!-- Histórico será carregado aqui -->
</div>
        </div>
      </div>
      
      <!-- Seção de Templates -->
      <div id="sec-templates" style="display:none;">
        <div class="panel-header">
          <h1><i class="fas fa-palette"></i> Templates de Assinatura</h1>
        </div>
        
        <div class="painel-form">
          <h2><i class="fas fa-clone"></i> Modelos Disponíveis</h2>
          <div style="text-align: center; padding: 30px;">
            <p>Selecione um template para aplicar à sua assinatura</p>
            
            <div class="template-options" style="display: flex; justify-content: center; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
              <div class="template-card" onclick="aplicarTemplate('padrao')" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px; text-align: center;">
                <div style="background: #f8fbfd; padding: 15px; margin-bottom: 10px;">
                  <div style="font-weight: bold; margin-bottom: 5px;">Willian Melo</div>
                  <div style="font-size: 0.9em; margin-bottom: 10px;">ANALISTA DE PROCESSOS</div>
                  <div style="font-size: 0.8em;">(94) 9 8809-9845</div>
                  <div style="font-size: 0.8em;">email@topgeo.com.br</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;">Padrão</button>
              </div>
              
              <div class="template-card" onclick="aplicarTemplate('moderno')" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px; text-align: center;">
                <div style="background: #f8fbfd; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary-color);">
                  <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 5px;">Willian Melo</div>
                  <div style="font-size: 0.9em; margin-bottom: 10px; color: var(--text-medium);">Analista de Processos</div>
                  <div style="font-size: 0.8em; color: var(--text-dark);">
                    <i class="fas fa-phone" style="margin-right: 5px;"></i> (94) 9 8809-9845
                  </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;">Moderno</button>
              </div>
              
              <div class="template-card" onclick="aplicarTemplate('clean')" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px; text-align: center;">
                <div style="background: #e0f7fa; padding: 15px; margin-bottom: 10px;">
                  <div style="font-weight: bold; color: #00bcd4; margin-bottom: 5px;">Modelo Clean</div>
                  <div style="font-size: 0.9em; margin-bottom: 10px; color: #333;">Simples e elegante</div>
                  <div style="font-size: 0.8em; color: #555;">(94) 9 8809-9845</div>
                  <div style="font-size: 0.8em; color: #555;">email@topgeo.com.br</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;">Clean</button>
              </div>
              
              <div class="template-card" onclick="aplicarTemplate('dark')" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px; text-align: center;">
                <div style="background: #1a5276; color: #fff; padding: 15px; margin-bottom: 10px;">
                  <div style="font-weight: bold; margin-bottom: 5px;">Modelo Dark</div>
                  <div style="font-size: 0.9em; margin-bottom: 10px;">Visual escuro</div>
                  <div style="font-size: 0.8em;">(94) 9 8809-9845</div>
                  <div style="font-size: 0.8em;">email@topgeo.com.br</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;">Dark</button>
              </div>
              
              <div class="template-card" onclick="aplicarTemplate('minimal')" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; width: 200px; text-align: center;">
                <div style="background: #fff; padding: 15px; margin-bottom: 10px; border: 1px solid #e0e9f2;">
                  <div style="font-weight: bold; color: #1a5276; margin-bottom: 5px;">Modelo Minimal</div>
                  <div style="font-size: 0.9em; margin-bottom: 10px; color: #555;">Discreto e limpo</div>
                  <div style="font-size: 0.8em; color: #1a5276;">(94) 9 8809-9845</div>
                  <div style="font-size: 0.8em; color: #1a5276;">email@topgeo.com.br</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;">Minimal</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Seção de Configurações -->
      <div id="sec-config" style="display:none;">
        <div class="panel-header">
          <h1><i class="fas fa-cog"></i> Configurações do Sistema</h1>
        </div>
        
        <div class="painel-form">
          <h2><i class="fas fa-user-cog"></i> Configurações de Usuário</h2>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="config-empresa"><i class="fas fa-building"></i> Nome da Empresa:</label>
              <input id="config-empresa" type="text" value="TOPGEO" disabled>
            </div>
            <div class="form-group">
              <label for="config-logo"><i class="fas fa-image"></i> URL do Logo:</label>
              <input id="config-logo" type="text" value="https://topgeobr.com/img/logo.png">
            </div>
            <div class="form-group">
              <label for="config-site"><i class="fas fa-globe"></i> Site Padrão:</label>
              <input id="config-site" type="text" value="www.topgeoengenharia.com.br">
            </div>
          </div>
          
          <div class="form-actions">
            <button class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
            <button class="btn btn-primary" onclick="salvarConfiguracoes()"><i class="fas fa-save"></i> Salvar Configurações</button>
          </div>
        </div>
        
        <div class="painel-form">
          <h2><i class="fas fa-file-export"></i> Exportar/Importar Dados</h2>
          
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="exportarHistorico()"><i class="fas fa-file-export"></i> Exportar Histórico</button>
            <button class="btn btn-primary" onclick="document.getElementById('importar-arquivo').click()"><i class="fas fa-file-import"></i> Importar Histórico</button>
            <input type="file" id="importar-arquivo" style="display: none;" accept=".json" onchange="importarHistorico(this)">
          </div>
        </div>
        
        <!-- Nova aba de cadastro de localidades -->
        <div class="painel-form">
          <h2><i class="fas fa-map-marker-alt"></i> Gerenciar Localidades</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <input id="nova-localidade" type="text" placeholder="Digite nova localidade..." style="flex:1;">
            <button class="btn btn-primary" onclick="adicionarLocalidade()"><i class="fas fa-plus"></i> Adicionar</button>
          </div>
          <ul id="lista-localidades" style="margin-top:15px; padding-left:20px;"></ul>
        </div>
      </div>
      
      <!-- Iframe para visualização de site -->
      <div id="iframe-site-container" style="display:none; text-align:center; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#f8fbfd; z-index:9999; padding:0; margin:0;">
  <button id="btn-voltar-site" class="btn btn-secondary"
    style="position:absolute;top:20px;right:30px;z-index:10;background:#f8fbfd;color:#1a5276;">
    <i class="fas fa-arrow-left"></i> Voltar
  </button>
  <iframe id="iframe-site" src="" style="width:100vw;height:100vh;min-height:100vh;border:none;background:#fff;"></iframe>
  <div id="iframe-erro" style="display:none; color:#d33; font-weight:bold; margin-top:30px; position:absolute;top:80px;left:0;width:100%;">
    <br>
    <a id="iframe-link-externo" href="#" target="_blank" style="color:#1a5276;text-decoration:underline;"></a>
  </div>
</div>
    </main>
  </div>

  <script>
    // Variáveis globais
    let assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
    let configuracoes = JSON.parse(localStorage.getItem('configuracoes')) || {
      empresa: 'TOPGEO',
      logo: 'https://topgeobr.com/img/logo.png',
      site: 'www.topgeoengenharia.com.br'
    };
    // Localidades
let localidades = JSON.parse(localStorage.getItem('localidades')) || ["Escritorio Central"];

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      // Carrega configurações
      carregarConfiguracoes();
      
      // Carrega histórico
      renderizarHistorico();
      atualizarKPIs();
      
      // Configura formatação de telefone
      document.getElementById('telefone1').addEventListener('input', formatarTelefone);
      document.getElementById('telefone2').addEventListener('input', formatarTelefone);
      
      // Configura formulário
      document.getElementById('form-assinatura').addEventListener('submit', function(e) {
        e.preventDefault();
        gerarAssinatura();
      });
      
      // Configura navegação
      configurarNavegacao();
      
      // Atualização em tempo real
      configurarAtualizacaoTempoReal();
      
      // Preenche o select de localidades
      preencherLocalidades();
      
      // Renderiza lista de localidades
      renderizarListaLocalidades();
    });

    // Função para formatar telefone
    function formatarTelefone(e) {
      let value = e.target.value.replace(/\D/g, '');

      if (value.length > 11) value = value.slice(0, 11);

      if (value.length > 0) {
        value = '(' + value;
      }
      if (value.length > 3) {
        value = value.slice(0, 3) + ') ' + value.slice(3);
      }
      if (value.length > 10) {
        value = value.slice(0, 10) + '-' + value.slice(10);
      } else if (value.length > 6) {
        value = value.slice(0, 9) + '-' + value.slice(9);
      }

      e.target.value = value;
    }

    // Função para gerar assinatura
    function gerarAssinatura() {
      // Sempre pega os valores do formulário, não da pré-visualização!
      const nome = document.getElementById('nome').value;
      const cargo = document.getElementById('cargo').value;
      const telefone1 = document.getElementById('telefone1').value;
      const telefone2 = document.getElementById('telefone2').value;
      const email = document.getElementById('email').value;
      const localidade = document.getElementById('localidade').value;
      const site = document.getElementById('site').value;

      // Atualiza a pré-visualização (opcional)
      atualizarPreviewAssinatura();

      // Salva no histórico
      salvarAssinatura(nome, cargo, telefone1, telefone2, email, localidade, site);
    }

    // Função para salvar assinatura
    function salvarAssinatura(nome, cargo, telefone1, telefone2, email, localidade, site) {
      const novaAssinatura = {
        id: Date.now(),
        nome,
        cargo,
        telefone1,
        telefone2,
        email,
        localidade,
        site,
        data: new Date().toLocaleString('pt-BR')
      };
      
      assinaturas.unshift(novaAssinatura);
      localStorage.setItem('assinaturas', JSON.stringify(assinaturas));
      
      // Atualiza UI
      renderizarHistorico();
      atualizarKPIs();
      
      // Feedback
      Swal.fire({
        icon: 'success',
        title: 'Assinatura criada!',
        text: 'Sua assinatura foi gerada com sucesso.',
        showConfirmButton: false,
        timer: 1500
      });
    }

    // Função para renderizar histórico
    function renderizarHistorico() {
      const lista = document.getElementById('historico-lista');
      
      if (assinaturas.length === 0) {
        lista.innerHTML = `
          <div style="text-align: center; padding: 30px; color: var(--text-medium);">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 15px;"></i>
            <p>Nenhuma assinatura criada ainda.</p>
          </div>
        `;
        return;
      }
      
      lista.innerHTML = assinaturas.map(assinatura => `
        <div class="historico-card" data-id="${assinatura.id}">
          <div class="historico-info">
            <div class="historico-nome">${assinatura.nome.toUpperCase()}</div>
            <div class="historico-cargo">${assinatura.cargo.toUpperCase()}</div>
            <div class="historico-contato">
              <span><i class="fas fa-phone"></i> ${assinatura.telefone1}</span>
              ${assinatura.telefone2 ? `<span><i class="fas fa-phone"></i> ${assinatura.telefone2}</span>` : ''}
              <span><i class="fas fa-envelope"></i> ${assinatura.email}</span>
            </div>
          </div>
          <div class="historico-data">${assinatura.data}</div>
          <div class="historico-acoes">
            <button class="btn-historico btn-editar" data-id="${assinatura.id}" title="Carregar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-historico btn-baixar" data-id="${assinatura.id}" title="Exportar">
              <i class="fas fa-download"></i>
            </button>
            <button class="btn-historico" onclick="excluirAssinatura('${assinatura.id}')" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');

      // Adiciona eventos aos botões de editar e baixar
      lista.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', function() {
          carregarAssinatura(this.getAttribute('data-id'));
        });
      });
      lista.querySelectorAll('.btn-baixar').forEach(btn => {
        btn.addEventListener('click', function() {
          exportarAssinatura(this.getAttribute('data-id'));
        });
      });
    }

    // Função para carregar assinatura do histórico
    function carregarAssinatura(id) {
      const assinatura = assinaturas.find(a => a.id == id);
      if (!assinatura) return;

      // Preenche o formulário
      document.getElementById('nome').value = assinatura.nome;
      document.getElementById('cargo').value = assinatura.cargo;
      document.getElementById('telefone1').value = assinatura.telefone1;
      document.getElementById('telefone2').value = assinatura.telefone2 || '';
      document.getElementById('email').value = assinatura.email;
      document.getElementById('localidade').value = assinatura.localidade;
      document.getElementById('site').value = assinatura.site;

      // Atualiza pré-visualização
      document.getElementById('sig-nome').textContent = assinatura.nome.toUpperCase();
      document.getElementById('sig-cargo').textContent = assinatura.cargo.toUpperCase();
      let telefones = assinatura.telefone1;
      if (assinatura.telefone2) {
        telefones += ' / ' + assinatura.telefone2;
      }
      document.getElementById('sig-telefones').textContent = telefones;
      document.getElementById('sig-email').textContent = assinatura.email;
      document.getElementById('sig-endereco').textContent = assinatura.localidade;
      document.getElementById('sig-site').textContent = assinatura.site;

      // Navega para a seção de criação
      document.getElementById('btn-painel').click();

      // Feedback
      Swal.fire({
        icon: 'success',
        title: 'Assinatura carregada!',
        text: 'Você pode editar e gerar uma nova versão.',
        showConfirmButton: false,
        timer: 1500
      });
    }

    // Função para exportar assinatura específica
    function exportarAssinatura(id) {
      const assinatura = assinaturas.find(a => a.id == id);
      if (!assinatura) return;

      // Atualiza pré-visualização
      document.getElementById('sig-nome').textContent = assinatura.nome.toUpperCase();
      document.getElementById('sig-cargo').textContent = assinatura.cargo.toUpperCase();
      let telefones = assinatura.telefone1;
      if (assinatura.telefone2) {
        telefones += ' / ' + assinatura.telefone2;
      }
      document.getElementById('sig-telefones').textContent = telefones;
      document.getElementById('sig-email').textContent = assinatura.email;
      document.getElementById('sig-endereco').textContent = assinatura.localidade;
      document.getElementById('sig-site').textContent = assinatura.site;

      // Garante que a pré-visualização está visível
      const secPainel = document.getElementById('sec-painel');
      const secHistorico = document.getElementById('sec-assinaturas');
      secPainel.style.display = '';
      secHistorico.style.display = 'none';

      // Aguarda o DOM atualizar e exporta
      setTimeout(() => {
        exportarPNG(assinatura.nome.replace(/\s+/g, '_'));
        // Volta para o histórico após exportar
        secPainel.style.display = 'none';
        secHistorico.style.display = '';
      }, 300);
    }

    // Função para excluir assinatura
    function excluirAssinatura(id) {
      Swal.fire({
        title: 'Confirmar exclusão',
        text: "Você realmente deseja excluir esta assinatura?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#1a5276',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sim, excluir!'
      }).then((result) => {
        if (result.isConfirmed) {
          assinaturas = assinaturas.filter(a => a.id != id);
          localStorage.setItem('assinaturas', JSON.stringify(assinaturas));
          renderizarHistorico();
          atualizarKPIs();
          
          Swal.fire(
            'Excluído!',
            'A assinatura foi removida do histórico.',
            'success'
          );
        }
      });
    }

    // Função para exportar como PNG
    function exportarPNG(filename = 'assinatura_topgeo') {
  const elemento = document.getElementById('assinatura');
  
  html2canvas(elemento, {
    backgroundColor: null,
    scale: 2,
    logging: false,
    useCORS: true // <-- Adicione esta linha
  }).then(canvas => {
    const link = document.createElement('a');
    link.download = `${filename}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    Swal.fire({
      icon: 'success',
      title: 'Exportado com sucesso!',
      text: 'Sua assinatura foi baixada como PNG.',
      showConfirmButton: false,
      timer: 1500
    });
  });
}

    // Função para exportar histórico
    function exportarHistorico() {
      const data = JSON.stringify(assinaturas, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'historico_assinaturas_topgeo.json';
      link.click();
      
      Swal.fire({
        icon: 'success',
        title: 'Histórico exportado!',
        text: 'Seu histórico foi baixado como arquivo JSON.',
        showConfirmButton: false,
        timer: 1500
      });
    }

    // Função para importar histórico
    function importarHistorico(input) {
      const file = input.files[0];
      
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!Array.isArray(data)) {
            throw new Error('Formato inválido');
          }
          
          Swal.fire({
            title: 'Confirmar importação',
            text: `Deseja importar ${data.length} assinaturas? Isso substituirá seu histórico atual.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1a5276',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, importar!'
          }).then((result) => {
            if (result.isConfirmed) {
              assinaturas = data;
              localStorage.setItem('assinaturas', JSON.stringify(assinaturas));
              renderizarHistorico();
              atualizarKPIs();
              
              Swal.fire(
                'Importado!',
                'Seu histórico foi importado com sucesso.',
                'success'
              );
            }
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Erro na importação',
            text: 'O arquivo selecionado não é válido.',
            confirmButtonColor: '#1a5276'
          });
        }
      };
      reader.readAsText(file);
    }

    // Função para atualizar KPIs
    function atualizarKPIs() {
      document.getElementById('kpi-total').textContent = assinaturas.length;

      // Conta quantas assinaturas têm verificada = true
      const verificadas = assinaturas.filter(a => a.verificada).length;
      document.getElementById('kpi-verificadas').textContent = verificadas;

      if (assinaturas.length > 0) {
        const ultima = new Date(assinaturas[0].id);
        document.getElementById('kpi-ultima').textContent = ultima.toLocaleDateString('pt-BR') + ', ' + ultima.toLocaleTimeString('pt-BR');
      } else {
        document.getElementById('kpi-ultima').textContent = '-';
      }
    }

    // Função para carregar configurações
    function carregarConfiguracoes() {
      document.getElementById('config-empresa').value = configuracoes.empresa;
      document.getElementById('config-logo').value = configuracoes.logo;
      document.getElementById('config-site').value = configuracoes.site;
      
      // Aplica configurações
      document.querySelector('.empresa').textContent = configuracoes.empresa;
      document.querySelectorAll('.assinatura-logo img').forEach(img => {
        img.src = configuracoes.logo;
      });
    }

    // Função para salvar configurações
    function salvarConfiguracoes() {
      configuracoes = {
        empresa: document.getElementById('config-empresa').value,
        logo: document.getElementById('config-logo').value,
        site: document.getElementById('config-site').value
      };
      
      localStorage.setItem('configuracoes', JSON.stringify(configuracoes));
      carregarConfiguracoes();
      
      Swal.fire({
        icon: 'success',
        title: 'Configurações salvas!',
        showConfirmButton: false,
        timer: 1500
      });
    }

    // Função para aplicar template
    function aplicarTemplate(tipo) {
      const assinatura = document.getElementById('assinatura');
      // Dados atuais do formulário
      const nome = document.getElementById('nome').value || 'Willian Melo';
      const cargo = document.getElementById('cargo').value || 'Analista de Processos';
      const telefone1 = document.getElementById('telefone1').value || '(94) 98809-9845';
      const telefone2 = document.getElementById('telefone2').value;
      const email = document.getElementById('email').value || 'email@topgeo.com.br';
      const localidade = document.getElementById('localidade').value || 'Escritório Central';
      const site = document.getElementById('site').value || 'www.topgeoengenharia.com.br';
      const telefones = telefone2 ? `${telefone1} / ${telefone2}` : telefone1;
      const logo = configuracoes.logo || 'https://topgeobr.com/img/logo.png';

      let html = '';
      if (tipo === 'padrao') {
        html = `
          <table style="width:100%; border:none;">
            <tr>
              <td style="width:160px; text-align:center; vertical-align:middle; padding:0 18px 0 0;">
                <img src="${logo}" alt="TOPGEO" style="height:60px; margin-top:8px; margin-bottom:8px;"><br>
              </td>
              <td style="width:3px; background:#1a5276; opacity:1;"></td>
              <td style="padding-left:18px; vertical-align:middle;">
                <div style="font-weight:700; font-size:1.18em; color:#000; margin-bottom:2px; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-user" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-nome">${nome}</span>
          <i class="fas fa-circle-check" style="color:#3498db; font-size:1em; margin-left:8px; text-shadow: 0 0 1px #fff;"></i>
        </div>
        <div style="font-size:1em; color:#000; font-weight:400; margin-bottom:7px; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-briefcase" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-cargo">${cargo}</span>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-phone" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-telefones">${telefones}</span>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-envelope" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <a id="sig-email-link" href="mailto:${email}" style="color:#1a5276; text-decoration:underline;">
            <span id="sig-email">${email}</span>
          </a>
        </div>
        <div style="font-size:0.98em; margin-bottom:2px; color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
          <i class="fas fa-map-marker-alt" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-endereco">${localidade}</span>
        </div>
        <div style="font-size:0.98em;">
          <i class="fas fa-globe" style="color:#000; text-shadow: 0 0 1px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <a id="sig-site-link" href="#" onclick="abrirSiteNaMesmaJanela()" style="color:#1a5276; text-decoration:underline;">
            <span id="sig-site">${site}</span>
          </a>
        </div>
      </td>
    </tr>
  </table>
        `;
      } else if (tipo === 'moderno') {
        html = `
    <div style="display:flex;align-items:center;gap:18px;">
      <img src="${logo}" style="height:60px;border-radius:12px;">
      <div>
        <div style="font-size:1.2em;font-weight:bold;color:#1a5276;">
          <span id="sig-nome" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${nome}</span>
        </div>
        <div style="font-size:1em;color:#555; margin-bottom:7px;">
          <span id="sig-cargo" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${cargo}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276; margin-bottom:2px;">
          <i class="fas fa-phone" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-telefones" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${telefones}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276; margin-bottom:2px;">
          <i class="fas fa-envelope" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-email" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${email}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276; margin-bottom:2px;">
          <i class="fas fa-map-marker-alt" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-endereco" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${localidade}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276;">
          <i class="fas fa-globe" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-site" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${site}</span>
        </div>
      </div>
    </div>
  `;
      } else if (tipo === 'clean') {
        html = `
    <div style="display:flex;align-items:center;gap:18px;">
      <img src="${logo}" style="height:50px;border-radius:8px;">
      <div style="border-left:6px solid #00bcd4;padding-left:18px;">
        <div style="font-size:1.15em;font-weight:700;color:#00bcd4;margin-bottom:2px;">
          <span id="sig-nome" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${nome}</span>
        </div>
        <div style="font-size:1em;color:#333;margin-bottom:7px;">
          <span id="sig-cargo" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${cargo}</span>
        </div>
        <div style="font-size:0.98em;color:#555;margin-bottom:2px;">
          <i class="fas fa-phone" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-telefones" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${telefones}</span>
        </div>
        <div style="font-size:0.98em;color:#555;margin-bottom:2px;">
          <i class="fas fa-envelope" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-email" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${email}</span>
        </div>
        <div style="font-size:0.98em;color:#555;margin-bottom:2px;">
          <i class="fas fa-map-marker-alt" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-endereco" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${localidade}</span>
        </div>
        <div style="font-size:0.98em;color:#555;">
          <i class="fas fa-globe" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-site" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${site}</span>
        </div>
      </div>
    </div>
  `;
      } else if (tipo === 'dark') {
        html = `
          <div style="display:flex;align-items:center;gap:18px;background:#1a5276;color:#fff;padding:18px 24px;border-radius:10px;box-shadow:0 2px 8px #0002;">
            <img src="${logo}" style="height:50px;border-radius:8px;background:#fff;padding:4px;">
            <div>
              <div style="font-size:1.15em;font-weight:700;margin-bottom:2px;"><span id="sig-nome">${nome}</span></div>
              <div style="font-size:1em;color:#b2c9dd;margin-bottom:7px;"><span id="sig-cargo">${cargo}</span></div>
              <div style="font-size:0.98em;margin-bottom:2px;">
                <i class="fas fa-phone"></i> <span id="sig-telefones">${telefones}</span>
              </div>
              <div style="font-size:0.98em;margin-bottom:2px;">
                <i class="fas fa-envelope"></i> <span id="sig-email">${email}</span>
              </div>
              <div style="font-size:0.98em;margin-bottom:2px;">
                <i class="fas fa-map-marker-alt"></i> <span id="sig-endereco">${localidade}</span>
              </div>
              <div style="font-size:0.98em;">
                <i class="fas fa-globe"></i> <span id="sig-site">${site}</span>
              </div>
            </div>
          </div>
        `;
      } else if (tipo === 'minimal') {
        html = `
    <div style="display:flex;align-items:center;gap:18px;border:1px solid #e0e9f2;padding:12px 18px;border-radius:8px;">
      <img src="${logo}" style="height:40px;border-radius:6px;">
      <div>
        <div style="font-size:1.1em;font-weight:700;color:#333;margin-bottom:2px;">
          <span id="sig-nome" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${nome}</span>
        </div>
        <div style="font-size:1em;color:#555;margin-bottom:7px;">
          <span id="sig-cargo" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${cargo}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276;margin-bottom:2px;">
          <i class="fas fa-phone" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-telefones" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${telefones}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276;margin-bottom:2px;">
          <i class="fas fa-envelope" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-email" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${email}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276;margin-bottom:2px;">
          <i class="fas fa-map-marker-alt" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-endereco" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${localidade}</span>
        </div>
        <div style="font-size:0.98em;color:#1a5276;">
          <i class="fas fa-globe" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;"></i>
          <span id="sig-site" style="text-shadow: 0 0 2px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${site}</span>
        </div>
      </div>
    </div>
  `;
      }

      assinatura.innerHTML = html;
atualizarPreviewAssinatura(); // <-- Adicione esta linha aqui

      Swal.fire({
        icon: 'success',
        title: 'Template aplicado!',
        text: `O template ${tipo} foi aplicado à sua assinatura.`,
        showConfirmButton: false,
        timer: 1200
      });
    }

    // Função para configurar navegação
    function configurarNavegacao() {
      const menuMap = [
        {btn: "btn-painel", sec: "sec-painel"},
        {btn: "btn-assinaturas", sec: "sec-assinaturas"},
        {btn: "btn-templates", sec: "sec-templates"},
        {btn: "btn-config", sec: "sec-config"}
      ];
      
      menuMap.forEach(({btn, sec}) => {
        document.getElementById(btn).addEventListener('click', (e) => {
          e.preventDefault();
          
          // Esconde todas as seções
          menuMap.forEach(({sec: s}) => {
            document.getElementById(s).style.display = 'none';
          });
          
          // Remove classe active de todos os botões
          menuMap.forEach(({btn: b}) => {
            document.getElementById(b).classList.remove('active');
          });
          
          // Mostra a seção clicada e ativa o botão
          document.getElementById(sec).style.display = '';
          document.getElementById(btn).classList.add('active');
        });
      });
    }

    // Função para configurar atualização em tempo real
    function configurarAtualizacaoTempoReal() {
      const campos = ['nome', 'cargo', 'telefone1', 'telefone2', 'email', 'localidade', 'site'];
      
      campos.forEach(campo => {
        const el = document.getElementById(campo);
        if (!el) return; // Evita erro se não existir
        el.addEventListener('input', function() {
          if (campo === 'nome') {
            document.getElementById('sig-nome').textContent = this.value.toUpperCase();
          } else if (campo === 'cargo') {
            document.getElementById('sig-cargo').textContent = capitalizeWords(this.value);
          } else if (campo === 'telefone1' || campo === 'telefone2') {
            const t1 = document.getElementById('telefone1').value;
            const t2 = document.getElementById('telefone2').value;
            let telefones = t1;
            if (t2) telefones += ' / ' + t2;
            document.getElementById('sig-telefones').textContent = telefones;
          } else if (campo === 'email') {
            document.getElementById('sig-email').textContent = this.value;
          } else if (campo === 'localidade') {
            document.getElementById('sig-endereco').textContent = this.value;
          } else if (campo === 'site') {
            document.getElementById('sig-site').textContent = this.value;
          }
        });
      });
    }

    function capitalizeWords(str) {
      return str.replace(/\w\S*/g, function(txt){
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }

    // Função para preencher localidades
function preencherLocalidades() {
  const select = document.getElementById('localidade');
  if (!select) return;
  select.innerHTML = localidades.map(loc => `<option value="${loc}">${loc}</option>`).join('');
}

// Função para renderizar lista de localidades
function renderizarListaLocalidades() {
  const ul = document.getElementById('lista-localidades');
  if (!ul) return;
  ul.innerHTML = localidades.map((loc, idx) => `
    <li>
      ${loc}
      <button onclick="removerLocalidade(${idx})" style="margin-left:10px; color:red; background:none; border:none; cursor:pointer;">
        <i class="fas fa-trash"></i>
      </button>
    </li>
   `).join('');
}

// Função para adicionar nova localidade
function adicionarLocalidade() {
  const input = document.getElementById('nova-localidade');
  const valor = input.value.trim();
  if (valor && !localidades.includes(valor)) {
    localidades.push(valor);
    localStorage.setItem('localidades', JSON.stringify(localidades));
    preencherLocalidades();
    renderizarListaLocalidades();
    input.value = '';
  }
}

// Função para remover localidade
function removerLocalidade(idx) {
  localidades.splice(idx, 1);
  localStorage.setItem('localidades', JSON.stringify(localidades));
  preencherLocalidades();
  renderizarListaLocalidades();
}

// Ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
  preencherLocalidades();
  renderizarListaLocalidades();
  
  // Garante que a logo da pré-visualização sempre use a configuração correta
  // Seleciona a imagem da pré-visualização
  const logoImg = document.querySelector('#assinatura img');
  if (logoImg && configuracoes.logo) {
    logoImg.src = configuracoes.logo;
  }
});
  
// Adicione antes da função aplicarTemplate:
function atualizarPreviewAssinatura() {
  const nome = document.getElementById('nome').value;
  const cargo = document.getElementById('cargo').value;
  const telefone1 = document.getElementById('telefone1').value;
  const telefone2 = document.getElementById('telefone2').value;
  const email = document.getElementById('email').value;
  const localidade = document.getElementById('localidade').value;
  const site = document.getElementById('site').value;

  let telefones = telefone1;
  if (telefone2) {
    telefones += ' / ' + telefone2;
  }

  if (document.getElementById('sig-nome')) document.getElementById('sig-nome').textContent = nome.toUpperCase();
  if (document.getElementById('sig-cargo')) document.getElementById('sig-cargo').textContent = cargo;
  if (document.getElementById('sig-telefones')) document.getElementById('sig-telefones').textContent = telefones;
  if (document.getElementById('sig-email')) document.getElementById('sig-email').textContent = email;
  if (document.getElementById('sig-endereco')) document.getElementById('sig-endereco').textContent = localidade;
  if (document.getElementById('sig-site')) {
    // Remove https:// ou http:// para exibir só a partir de www
    let siteDisplay = site.replace(/^https?:\/\//, '');
    document.getElementById('sig-site').textContent = siteDisplay;
  }
  if (document.getElementById('sig-site-link')) {
    let siteUrl = site.startsWith('http') ? site : 'https://' + site.replace(/^https?:\/\//, '');
    document.getElementById('sig-site-link').href = siteUrl;
  }
}

function abrirSiteNaMesmaJanela() {
  const site = document.getElementById('site').value.trim();
  let url = site;
  if (!/^https?:\/\//i.test(url)) {
    url = 'https://' + url.replace(/^https?:\/\//, '');
  }
  document.getElementById('iframe-site').src = url;
  document.getElementById('iframe-site-container').style.display = '';
  document.getElementById('iframe-erro').style.display = 'none'; // <-- Oculta sempre ao abrir
  document.querySelectorAll('.main-panel > *:not(#iframe-site-container)').forEach(el => el.style.display = 'none');

  document.getElementById('iframe-site').onload = function() {
    setTimeout(() => {
      try {
        const doc = document.getElementById('iframe-site').contentDocument;
        if (!doc || doc.body.innerHTML.trim() === "") {
          throw new Error();
        }
        document.getElementById('iframe-erro').style.display = 'none';
      } catch (e) {
        document.getElementById('iframe-erro').style.display = '';
        document.getElementById('iframe-link-externo').href = url;
      }
    }, 1000);
  };
}

// Botão voltar do iframe
document.getElementById('btn-voltar-site').onclick = function() {
  document.getElementById('iframe-site-container').style.display = 'none';
  // Esconde todas as seções principais
  document.getElementById('sec-painel').style.display = '';
  document.getElementById('sec-assinaturas').style.display = 'none';
  document.getElementById('sec-templates').style.display = 'none';
  document.getElementById('sec-config').style.display = 'none';
  // Ativa o botão do painel
  document.getElementById('btn-painel').classList.add('active');
  document.getElementById('btn-assinaturas').classList.remove('active');
  document.getElementById('btn-templates').classList.remove('active');
  document.getElementById('btn-config').classList.remove('active');
  document.getElementById('iframe-site').src = '';
  document.getElementById('iframe-erro').style.display = 'none';
};
  </script>
</body>
</html>